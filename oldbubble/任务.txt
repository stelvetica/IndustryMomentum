这是一个非常硬核的量化因子构建任务。以下是基于兴业证券研报《如何结合行业轮动的长短信号？》的详细复现指南，我将其拆解为两个独立的模块：**BSADF（泡沫检测）** 和 **BOCD（变点检测）**。

---

# 模块一：BSADF (Backward Sup ADF) —— 泡沫检测因子

### 1. 理念 (Idea)

*   **核心思想**：理性泡沫理论。假设资产价格不仅包含基本面价值，还包含理性泡沫成分。泡沫的特征是价格呈现**“爆炸性”（Explosive）**行为，即偏离随机游走，呈现指数级加速。

*   **设计逻辑**：传统的ADF检验主要用于检测平稳性（是否均值回归）。BSADF通过**改变检测窗口的起始点**（向后回溯），能够灵敏地捕捉到局部时间段内的爆炸性趋势，即使这种趋势在长周期历史中被淹没。

*   **理论依据**：Phillips, Wu and Yu (2011) 及后续 PSY (2015) 提出的计量经济学方法。

### 2. 构造 (Construction)

*   **基础模型**：带截距项的ADF回归方程：

    $$ \Delta y_t = \alpha + \beta y_{t-1} + \sum_{i=1}^{k} \delta_i \Delta y_{t-i} + \epsilon_t $$

    *   $y_t$: 时间序列（对数价格或对数成交额）。

    *   $\beta$: 我们关注的核心系数。若 $\beta > 0$ 显著，则存在泡沫。

    *   $k$: 滞后阶数（通常取0或1，研报中需根据AIC准则或固定较小值）。

*   **BSADF统计量定义**：

    对于当前时刻 $T$，BSADF值是所有可能的起始点 $r_1$ 对应的ADF t统计量的**最大值**：

    $$ BSADF_T(r_0) = \sup_{r_1 \in [0, T-r_0]} \{ ADF_{r_1}^T \} $$

    *   $r_0$: 最小检测窗口宽度。

### 3. 步骤 (Steps)

#### 第一步：数据预处理

1.  获取行业指数的**周频收盘价 ($P_t$)** 和 **周频成交额 ($V_t$)**。

2.  分别取自然对数：$ \ln(P_t) $, $ \ln(V_t) $。

#### 第二步：滚动计算 BSADF 序列

对于每一个时间点 $t$（假设从2005年开始）：

1.  **设定这一刻的终点**：End = $t$。

2.  **设定最小窗口**：$Win_{min} \approx 52$周（研报公式：$(0.01 + 1.8/\sqrt{T})T$，实操中建议固定为一年左右，如40-60周）。

3.  **循环回溯**：

    *   Start = $t - Win_{min}$

    *   Start = $t - Win_{min} - 1$

    *   ...

    *   Start = 0 (数据起点)

4.  **运行回归**：对每一个 [Start, End] 区间的数据，运行上述 ADF 回归方程。

5.  **提取 t值**：计算 $\beta$ 的 t统计量 ($t = \hat{\beta} / SE_{\beta}$)。

6.  **取最大值**：记录这一系列 t值 中的最大值，作为时刻 $t$ 的 **BSADF值**。

7.  **结果**：你将得到两条序列：`BSADF_Price` 和 `BSADF_Volume`。

#### 第三步：信号生成（研报逻辑）

1.  **计算基准**：对过去 **40周** 的 `BSADF_Price` 和 `BSADF_Volume` 分别计算**滚动中位数**。

2.  **触发判断**：

    *   if (`BSADF_Price` > 40周Price中位数) **AND** (`BSADF_Volume` > 40周Volume中位数):

    *   Output **Signal = 1** (泡沫存在)

    *   Else: **Signal = 0**

---

# 模块二：BOCD (Bayesian Online Changepoint Detection) —— 变点检测因子

### 1. 理念 (Idea)

*   **核心思想**：贝叶斯推断。市场的时间序列参数（均值、方差等）也是随机变量。所有的“异常”本质上是旧模型的解释力下降，新模型的解释力上升。

*   **设计逻辑**：不依赖滞后的均线，而是实时计算“当前趋势已经持续了多久”（Run Length）。如果模型发现新数据很难用旧分布解释，它会调高“Run Length = 0”（新趋势开始）的概率。

*   **理论依据**：Adams & MacKay (2007) 提出的在线变点检测算法。

### 2. 构造 (Construction)

这是一个递归迭代过程。我们需要维护两个核心变量：

1.  **游程长度 (Run Length, $r_t$) 的概率分布**：$P(r_t | x_{1:t})$。

2.  **分布的超参数 (Hyperparameters)**：通常假设收益率服从高斯分布，其共轭先验是 **Normal-Inverse-Gamma (NIG)** 分布。

*   **核心递归公式**：

    $$ P(r_t, x_t | x_{1:t-1}) = \sum_{r_{t-1}} P(r_t | r_{t-1}) \cdot P(x_t | r_{t-1} \text{的参数}) \cdot P(r_{t-1} | x_{1:t-1}) $$

    *   **先验转换 (Hazard Function)**: 旧趋势继续的概率 vs 突变发生的概率。

    *   **预测似然 (Likelihood)**: 新数据 $x_t$ 在当前参数下的概率密度（Student-t分布）。

### 3. 步骤 (Steps)

#### 第一步：数据准备

1.  获取行业指数的 **周频收益率 ($R_t$)**。注意这里用收益率，不是价格。

#### 第二步：初始化贝叶斯参数

1.  我们需要四个超参数来描述正态-逆伽马分布：

    *   $\mu_0$ (均值猜想，设为0)

    *   $\kappa_0$ (相信均值的程度，设为1)

    *   $\alpha_0$ (形状参数，设为较大值如50以稳定方差)

    *   $\beta_0$ (尺度参数，设为能覆盖常见波动率的值)

2.  初始化游程概率矩阵 `R`，第一行设为1（必定是起点）。

#### 第三步：在线迭代（逐周读取数据）

对于每一个新进来的收益率 $x_t$：

1.  **计算预测概率 (Predictive Prob)**：

    *   根据上一时刻 $t-1$ 对应的各种可能游程长度的参数，计算 $x_t$ 出现的概率密度（使用 Student-t PDF）。

    *   *直觉*：如果 $x_t$ 很大，而旧参数认为方差很小，这个概率密度就会极低。

2.  **计算增长概率 vs 变点概率**：

    *   **增长（No Change）**：$P(r_t = r_{t-1} + 1) \propto P(r_{t-1}) \times Likelihood \times (1 - Hazard)$

    *   **主要变点（Change）**：$P(r_t = 0) \propto \sum (P(r_{t-1}) \times Likelihood \times Hazard)$

    *   *注*：Hazard通常设为常数 $1/\lambda$，如 1/100。

3.  **归一化**：确保 $t$ 时刻的所有游程概率之和为1。

4.  **更新参数**：对于 $r_t$ 的每一种可能长度，更新对应的 $\mu, \kappa, \alpha, \beta$（标准贝叶斯更新公式）。

#### 第四步：信号提取（研报逻辑）

1.  **计算突变概率**：研报没有明确公式，但通常做法是取 $r_t \le 2$ 或 $3$ 的概率之和，或者直接看 $P(Change)$ 的上升趋势。

2.  **触发判断**：

    *   提取 t 时刻的“突变概率” $P_{change}(t)$。

    *   **Condition**：最近 **3周** 的 $P_{change}$ 是否**单调递增**。

    *   即：$P_t > P_{t-1} > P_{t-2}$。

    *   Output **Signal = 1** (变点确认)

---

# 综合：策略实现与注意事项

### 1. 策略合成逻辑 (研报复现)

最终的行业多头信号是：

$$ \text{Signal}_{Final} = \left( BSADF_{Price\&Vol} == 1 \quad \textbf{OR} \quad BOCD_{Inc} == 1 \right) \quad \textbf{AND} \quad (R_t > 0) $$

*   **注**：必须叠加 $R_t > 0$（动量过滤），因为研报指出要剔除反向泡沫（下跌过程中的崩盘也会触发BSADF和BOCD，但我们只做多）。

### 2. 出处

*   **研报名称**：**《如何结合行业轮动的长短信号？》**

*   **券商**：兴业证券 (Industrial Securities)

*   **分析师**：郑兆磊、刘海燕

*   **发布日期**：2022年5月27日

### 3. 重要注意事项 (Implementation Pitfalls)

1.  **计算性能（非常重要）**：

    *   **BSADF** 是 $O(N^2)$ 复杂度的。如果你有20年周数据（1000周），每一周都要回溯跑几百次回归。用 Python 的 `statsmodels.adfuller` 跑循环会**非常慢**。

    *   *建议*：手写矩阵运算形式的OLS回归公式 $\hat{\beta} = (X'X)^{-1}X'Y$，利用 `numpy` 广播机制加速，或者使用 `numba` 进行加速。

2.  **滞后阶数 (Lag Order)**：

    *   ADF回归中的 lag $j$ 选多少？研报未详述。通常为了稳健，设为 **0** 或 **1** 即可。过高的 lag 会消耗自由度，降低对爆发性泡沫的敏感度。

3.  **BOCD 的 Hazard Rate**：

    *   危险率（Hazard Rate）是一个敏感参数。设得太高（如 1/10），模型会觉得天天都在变；设得太低（如 1/1000），模型反应会很迟钝。建议设为 **1/50 到 1/100** 之间。

4.  **数据对数化**：

    *   BSADF **必须**使用 Log Price。因为泡沫是 $e^{rt}$ 形式的，取对数变成线性 $rt$，才符合ADF线性回归的假设。不要直接用原始价格。

    ==============================

    你可以直接复制以下内容，作为提示词（Prompt）发送给你的AI编程助手。

这份笔记已经将**业务逻辑**转化为**开发需求文档**，特别强调了**性能优化**（手写OLS）和**细节参数**（研报特有逻辑），能最大程度避免AI写出“能跑但慢得要死”或者“逻辑不符合研报”的代码。

---

### **任务说明书：复现兴业证券行业轮动策略核心算法 (BSADF & BOCD)**

**背景：**

我们需要基于兴业证券研报《如何结合行业轮动的长短信号？》，复现两个用于量化择时的非线性信号算子。

**技术栈要求：**

- 语言：Python 3.x

- 核心库：`numpy` (必须用于加速矩阵运算), `pandas`, `scipy`

- **严禁**：在BSADF的高频循环中调用 `statsmodels` 或 `arch` 库（速度太慢），必须使用 `numpy` 实现底层 OLS 回归。

---

#### **模块一：BSADF (泡沫检测因子)**

**1. 核心逻辑：**

基于 Backward Sup ADF (Augmented Dickey-Fuller) 检验。对于每一个时间点 $T$，向回回溯不同的起点 $r_1$，计算一系列 ADF 是统计量，取最大值作为当期的 BSADF 值。

**2. 数据输入：**

- $P_t$：对数处理后的价格序列 (`np.log(price)`)

- $V_t$：对数处理后的成交额序列 (`np.log(volume)`)

- 频率：周频 (Weekly)

**3. 算法实现细节 (必须严格遵守)：**

- **回归方程**：使用带截距项、无时间趋势项、Lag=0 的简化模型：

  $$ \Delta y_t = \alpha + \beta y_{t-1} + \epsilon_t $$

  我们需要提取的是系数 $\beta$ 的 **t-statistic** ($t = \hat{\beta} / SE_{\beta}$)。

- **Rolling逻辑**：

  - 设定最小窗口 `min_window` (例如 52 周)。

  - 对于每一个当前时间点 `current_idx` (从 `min_window` 到 `len(data)`):

    - 遍历 `start_idx` 从 `0` 到 `current_idx - min_window`。

    - 对切片数据 `data[start_idx : current_idx]` 进行 OLS 回归。

    - 记录该切片的 t-stat。

  - `BSADF_val[current_idx] = MAX(所有切片的 t-stats)`

- **性能优化 (关键)**：

  - 请编写一个名为 `fast_ols_t_stat(y)` 的函数，利用 `numpy` 的矩阵运算 (`np.linalg.solve` 或 `np.linalg.inv`) 直接计算 $\beta$ 和标准误，避免使用高级统计库。

**4. 信号生成逻辑 (Signal Generation)：**

- 计算出 Price 和 Volume 的 BSADF 序列后。

- 计算基准：过去 40 周的滚动中位数 (`rolling(40).median()`)。

- **Signal = 1 当且仅当**：

  - (Current BSADF_Price > Median BSADF_Price) **AND** (Current BSADF_Vol > Median BSADF_Vol)

---

#### **模块二：BOCD (贝叶斯在线变点检测因子)**

**1. 核心逻辑：**

基于 Adams & MacKay (2007) 的 Bayesian Online Changepoint Detection。实时计算当前时刻发生突变（Run Length = 0）的概率。

**2. 数据输入：**

- $R_t$：行业指数的周收益率序列 (Returns)。假设服从正态分布。

**3. 算法实现细节：**

- **模型假设**：数据服从高斯分布，均值和方差未知 (Gaussian Unknown Mean and Variance)。

- **先验分布**：使用 Normal-Inverse-Gamma (NIG) 共轭先验。

  - 需要维护四个参数：$\mu, \kappa, \alpha, \beta$。

- **Hazard Function**：常数危险率，设 $\lambda = 100$ (即 $H = 1/100$)。

- **迭代过程**：

  - 维护一个向量 `R`，表示当前游程长度的概率分布。

  - 每进来一个新数据 $x_t$，计算预测概率 (Predictive Probability, 使用 Student-t PDF)。

  - 更新 `R` 向量：计算 "继续延伸" 和 "发生突变" 的概率。

  - 更新后验参数 (update hyperparameters)。

- **输出**：每一期的 `Change_Prob` (即 $P(r_t=0)$)。

**4. 信号生成逻辑 (Signal Generation)：**

- **Signal = 1 当且仅当**：

  - 最近 3 周的 `Change_Prob` 单调递增。

  - 即：`Prob[t] > Prob[t-1] > Prob[t-2]`。

---

#### **模块三：最终策略组合**

请提供一个主函数，将上述模块整合，输入一个 Dataframe (包含 Price, Volume)，输出最终信号。

**组合公式：**

$$ \text{Buy Signal} = (\text{Signal}_{BSADF} \lor \text{Signal}_{BOCD}) \land (\text{Return}_t > 0) $$

**代码要求：**

1. 请使用 Class 结构封装 BOCD，以保持状态。

2. 请使用 Numba (如果可能) 或纯 Numpy 优化 BSADF 的循环。

3. 代码需要有清晰的注释。

====================================

根据以上两篇笔记，检查代码 bubbleold\positive_bubble_backtest.py 看看是否有什么可以参考的地方 
以最新笔记为准在新的py文件重新构建该行业因子，该行业因子的输出是每个调仓日的选出来的行业么？

同时检查该因子的分析，具体分析内容给出： 
年化收益率(%)	年化波动率(%)	最大回撤(%)	收益风险比	收益回撤比	月度胜率(%)
以及每年的多头收益% 超额收益% 基准%
每次调仓的单位净值多头收益 超额收益 基准
每次调仓选出来的行业
基准用行业均值

